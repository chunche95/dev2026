version: '3.8'

services:
  postgres:
      image: postgres:15-alpine
          container_name: n8n-postgres
              environment:
                    POSTGRES_DB: ${POSTGRES_DB:-n8n}
                          POSTGRES_USER: ${POSTGRES_USER:-n8n}
                                POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                                    volumes:
                                          - postgres_data:/var/lib/postgresql/data
                                              ports:
                                                    - "127.0.0.1:5432:5432"
                                                        healthcheck:
                                                              test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-n8n}"]
                                                                    interval: 10s
                                                                          timeout: 5s
                                                                                retries: 5
                                                                                    restart: unless-stopped
                                                                                        networks:
                                                                                              - n8n-network

                                                                                                n8n:
                                                                                                    image: n8nio/n8n:latest
                                                                                                        container_name: n8n-app
                                                                                                            environment:
                                                                                                                  DB_TYPE: postgresdb
                                                                                                                        DB_POSTGRESDB_HOST: postgres
                                                                                                                              DB_POSTGRESDB_PORT: 5432
                                                                                                                                    DB_POSTGRESDB_DATABASE: ${POSTGRES_DB:-n8n}
                                                                                                                                          DB_POSTGRESDB_USER: ${POSTGRES_USER:-n8n}
                                                                                                                                                DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
                                                                                                                                                      N8N_BASIC_AUTH_ACTIVE: 'true'
                                                                                                                                                            N8N_BASIC_AUTH_USER: ${N8N_USER:-admin}
                                                                                                                                                                  N8N_BASIC_AUTH_PASSWORD: ${N8N_PASSWORD}
                                                                                                                                                                        N8N_HOST: localhost
                                                                                                                                                                              N8N_PORT: 5678
                                                                                                                                                                                    N8N_PROTOCOL: http
                                                                                                                                                                                          WEBHOOK_URL: http://127.0.0.1:5678/
                                                                                                                                                                                                GENERIC_TIMEZONE: ${TIMEZONE:-UTC}
                                                                                                                                                                                                    depends_on:
                                                                                                                                                                                                          postgres:
                                                                                                                                                                                                                  condition: service_healthy
                                                                                                                                                                                                                      ports:
                                                                                                                                                                                                                            - "127.0.0.1:5678:5678"
                                                                                                                                                                                                                                healthcheck:
                                                                                                                                                                                                                                      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
                                                                                                                                                                                                                                            interval: 30s
                                                                                                                                                                                                                                                  timeout: 10s
                                                                                                                                                                                                                                                        retries: 3
                                                                                                                                                                                                                                                              start_period: 30s
                                                                                                                                                                                                                                                                  restart: unless-stopped
                                                                                                                                                                                                                                                                      networks:
                                                                                                                                                                                                                                                                            - n8n-network
                                                                                                                                                                                                                                                                                volumes:
                                                                                                                                                                                                                                                                                      - n8n_data:/home/node/.n8n
                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                      volumes:
                                                                                                                                                                                                                                                                                        postgres_data:
                                                                                                                                                                                                                                                                                            driver: local
                                                                                                                                                                                                                                                                                              n8n_data:
                                                                                                                                                                                                                                                                                                  driver: local
                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                  networks:
                                                                                                                                                                                                                                                                                                    n8n-network:
                                                                                                                                                                                                                                                                                                        driver: bridge
                                                                                                                                                                                                                                                                                                        
